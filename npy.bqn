âŸ¨SaveNpy,LoadNpyâŸ©â‡

lfâ†@+10
magicStringâ†(@+147)âˆ¾"NUMPY"

# Type conversions
dtypesâ€¿formatsâ†âŸ¨"<f8","<i4","<u4"âŸ©â€¿âŸ¨64â€¿'f',32â€¿'i',32â€¿'u'âŸ©
DtypeToFormatâ†{(âŠ‘dtypesâŠ<ğ•©)âŠ‘formats}
ArrayToBytesâ†{âŸ¨DtypeToFormat ğ•¨,8â€¿'c'âŸ©â€¢bit._cast ğ•©}
ArrayFromBytesâ†{âŸ¨8â€¿'c',DtypeToFormat ğ•¨âŸ©â€¢bit._cast ğ•©}

# Saving
To_i16leâ†{@+256(|âˆ¾âŒŠâˆ˜Ã·Ëœ)ğ•©}
FormatShapeâ†{'('âˆ¾(1â†“âˆ¾â¥Š','âˆ¾Ë˜â€¢FmtÂ¨â‰¢ğ•©)âˆ¾')'}

BuildHeaderâ†{dtype ğ•Š data:
  versionâ†1â€¿0
  # Hypothesis: BQN arrays are C-contiguous
  headerDataâ†"{'descr':'"âˆ¾dtypeâˆ¾"','fortran_order':False,'shape':"âˆ¾(FormatShape data)âˆ¾",}"
  paddingâ†' 'â†‘Ëœ64-64|(â‰ magicString)+2+2+(â‰ headerData)+1
  ! 0=64|(â‰ magicString)+2+2+(â‰ padding)+(â‰ headerData)+1
  headerDataPaddedâ†headerDataâˆ¾paddingâˆ¾lf
  magicStringâˆ¾(@+version)âˆ¾(To_i16le â‰ headerDataPadded)âˆ¾headerDataPadded
}
DetectDtypeâ†{(âˆ§Â´â¥ŠâŒŠâŠ¸=Â¨ğ•©)âŠ‘âŸ¨"<f8",(âˆ§Â´â¥Š0â‰¤ğ•©)âŠ‘"<i4"â€¿"<u4"âŸ©}
EncodeNpyâ†DetectDtypeâŠ¸(BuildHeaderâˆ¾ArrayToBytesâŸœâ¥Š)
SaveNpyâ†â€¢file.BytesâŸœEncodeNpy

# Loading
ParseHeaderâ†{ğ•Šğ•©:
  "Not a valid NPY file"! magicStringâ‰¡(â‰ magicString)â†‘ğ•©
  versionâ†@-Ëœ(0â€¿1+â‰ magicString)âŠğ•©
  headerlenâ†+Â´1â€¿256Ã—@-Ëœ(2â€¿3+â‰ magicString)âŠğ•©
  headerâ†(Â¬âˆŠâŸœ(' 'âˆ¾lf))âŠ¸/headerlenâ†‘(4+â‰ magicString)â†“ğ•©
  dtypeâ†3â†‘(âŒŠÂ´âˆ˜âŠâŸœ"<>"â†“âŠ¢) (("descr"â·header)âŠ1)â†“header
  ("Unsupported dtype: "âˆ¾dtype) ! âŠ‘(<dtype)âˆŠdtypes
  shapestrâ†(âŠâŸœ')'â†‘âŠ¢) (1âŠ¸+âˆ˜âŠâŸœ'('â†“âŠ¢) (("shape"â·header)âŠ1)â†“header
  shapeâ†â€¢BQNÂ¨','((âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢)shapestr
  âŸ¨version,dtype,shape,headerlen+2+2+â‰ magicStringâŸ©
}

LoadNpyâ†{ğ•Šğ•©:
  bytesâ†â€¢file.Bytes ğ•©
  versionâ€¿dtypeâ€¿shapeâ€¿datastartâ†ParseHeader bytes
  shapeâ¥Šdtype ArrayFromBytes datastartâ†“bytes
}
